# 03 — GitHub Copilot Mapping Override (append to Port's default mapping)
# Where: Data sources → GitHub Copilot → Mapping
# Purpose: add top editor/language and expose chat fields; do not change existing identifiers.

resources:
  - kind: copilot-organization-metrics
    selector: { query: 'true' }
    port:
      entity:
        mappings:
          # Keep identifier/title/blueprint identical to Port's default
          identifier: (.__organization.login + "@" + .date)
          title: (.__organization.login + " copilot-metrics " + .date)
          blueprint: '"github_copilot_usage"'
          properties:
            record_date: .date + "T00:00:00Z"
            breakdown: .
            total_suggestions_count: >-
              [.copilot_ide_code_completions.editors[]?.models[]?.languages[]?.total_code_suggestions] | map(select(. != null)) | add
            total_acceptances_count: >-
              [.copilot_ide_code_completions.editors[]?.models[]?.languages[]?.total_code_acceptances] | map(select(. != null)) | add
            total_lines_suggested: >-
              [.copilot_ide_code_completions.editors[]?.models[]?.languages[]?.total_code_lines_suggested] | map(select(. != null)) | add
            total_lines_accepted: >-
              [.copilot_ide_code_completions.editors[]?.models[]?.languages[]?.total_code_lines_accepted] | map(select(. != null)) | add
            total_active_users: .total_active_users
            total_chat_acceptances: >-
              [( .copilot_ide_chat.editors[]?.models[]?.total_chat_copy_events // 0 ),
               ( .copilot_ide_chat.editors[]?.models[]?.total_chat_insertion_events // 0 )] | map(select(. != null)) | add
            total_chat_turns: >-
              [.copilot_ide_chat.editors[]?.models[]?.total_chats // 0] | map(select(. != null)) | add
            total_active_chat_users: >-
              [.copilot_ide_chat.editors[]?.total_engaged_users // 0] | map(select(. != null)) | add
            git_hub_org: .__organization.login

            # New: most-used editor & language by engaged users
            editor_top: >-
              ( .copilot_ide_code_completions.editors // [] ) | max_by(.total_engaged_users // 0) | .name // empty
            language_top: >-
              ( .copilot_ide_code_completions.languages // [] ) | max_by(.total_engaged_users // 0) | .name // empty
